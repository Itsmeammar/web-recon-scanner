#!/usr/bin/env python3

print("""
███████╗███╗   ██╗██████╗ ███████╗██████╗ 
██╔════╝████╗  ██║██╔══██╗██╔════╝██╔══██╗
█████╗  ██╔██╗ ██║██║  ██║█████╗  ██████╔╝
██╔══╝  ██║╚██╗██║██║  ██║██╔══╝  ██╔══██╗
███████╗██║ ╚████║██████╔╝███████╗██║  ██║
╚══════╝╚═╝  ╚═══╝╚═════╝ ╚══════╝╚═╝  ╚═╝
                                          
           Created by AMMAR 404            
""")

"""
Automated Website Vulnerability Assessment Scanner
This script automatically runs five reconnaissance tools for vulnerability assessment.
It performs scanning and reconnaissance only, without any exploitation attempts.

DISCLAIMER: This tool is for educational purposes and authorized testing only.
Always get proper permission before scanning any website. Unauthorized scanning
is illegal and unethical. The authors are not responsible for misuse of this tool.
"""

import os
import subprocess
import sys
import argparse
import time
import urllib.parse
import json

def check_tool_installed(tool_name):
    """Check if a tool is installed on the system"""
    try:
        subprocess.run(f"which {tool_name}", shell=True, check=True, 
                      stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        return True
    except subprocess.CalledProcessError:
        return False

def check_all_tools():
    """Check if all required tools are installed"""
    tools = ["nmap", "curl", "dig"]
    missing_tools = []
    
    for tool in tools:
        if not check_tool_installed(tool):
            missing_tools.append(tool)
    
    if missing_tools:
        print("\n[!] The following tools are not installed:")
        for tool in missing_tools:
            print(f"    - {tool}")
        print("\n[!] Please install the missing tools before using this script.")
        print("[!] You can install them using: sudo apt install nmap curl dnsutils")
        return False
    
    return True

def display_intro():
    """Display the introduction and disclaimer"""
    print("""
    ==========================================================
    AUTOMATED WEBSITE VULNERABILITY ASSESSMENT SCANNER
    ==========================================================
    
    This script automatically runs five reconnaissance tools for vulnerability assessment:
    1. IP Discovery - Uses dig +short to find the IP address
    2. Nmap - Network scanning and host discovery
    3. Security Headers Check - Checks for important security headers
    4. Directory Discovery - Basic directory enumeration
    5. Server Information - Gathers server and technology information
    
    DISCLAIMER: This tool is for educational purposes and authorized testing only.
    Always get proper permission before scanning any website. Unauthorized scanning
    is illegal and unethical. The authors are not responsible for misuse of this tool.
    ==========================================================
    """)

def get_authorization():
    """Get confirmation from the user that they have authorization to scan the target"""
    print("\n[!] IMPORTANT: You must have explicit permission to scan the target website.")
    print("[!] Unauthorized scanning is illegal and unethical.")
    
    authorized = input("[?] Do you have permission to scan this target? (yes/no): ")
    
    if authorized.lower() != "yes":
        print("\n[!] Scanning aborted. Please only scan targets you have permission to scan.")
        return False
    
    return True

def extract_hostname(url):
    """Extract hostname from URL"""
    parsed = urllib.parse.urlparse(url)
    return parsed.netloc

def format_time(seconds):
    """Format time in seconds to minutes and seconds"""
    minutes = int(seconds // 60)
    seconds = int(seconds % 60)
    return f"{minutes}m {seconds}s"

def run_nmap(target, ip_address):
    """Run Nmap for basic port scanning"""
    print("\n[+] Running Nmap...")
    print(f"[+] Executing: nmap -F -sV -T5 {ip_address}")
    
    start_time = time.time()
    hostname = extract_hostname(target)
    output_file = f"scan_results/nmap_{hostname.replace('.', '_')}.txt"
    
    try:
        # Create output file
        with open(output_file, 'w') as f:
            f.write("Nmap scan results\n")
            f.write("=" * 50 + "\n\n")
        
        # Run nmap and save output
        with open(output_file, 'a') as f:
            process = subprocess.Popen(
                f"nmap -F -sV -T5 {ip_address}",
                shell=True,
                stdout=f,
                stderr=subprocess.STDOUT,
                text=True
            )
            process.wait()
        
        elapsed_time = time.time() - start_time
        print(f"[+] Nmap scan completed (took {format_time(elapsed_time)})")
        return True, elapsed_time
    except Exception as e:
        elapsed_time = time.time() - start_time
        print(f"[!] Error running Nmap: {e} (took {format_time(elapsed_time)})")
        return False, elapsed_time

def check_security_headers(target):
    """Check for important security headers"""
    print("\n[+] Running Security Headers Check...")
    print(f"[+] Checking security headers for {target}")
    
    start_time = time.time()
    hostname = extract_hostname(target)
    output_file = f"scan_results/security_headers_{hostname.replace('.', '_')}.txt"
    
    headers_to_check = [
        "X-Frame-Options",
        "X-Content-Type-Options",
        "X-XSS-Protection",
        "Content-Security-Policy",
        "Strict-Transport-Security",
        "Referrer-Policy",
        "Permissions-Policy"
    ]
    
    try:
        with open(output_file, 'w') as f:
            f.write("Security Headers Check Results\n")
            f.write("=" * 50 + "\n\n")
            
            # Get server headers with -k to ignore SSL issues
            result = subprocess.run(
                f"curl -k -s -I {target}",
                shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True
            )
            
            headers = result.stdout
            f.write("Response Headers:\n")
            f.write("-" * 50 + "\n")
            f.write(headers)
            f.write("\n" + "=" * 50 + "\n\n")
            
            # Check for security headers
            f.write("Security Headers Analysis:\n")
            f.write("-" * 50 + "\n")
            
            missing_headers = []
            present_headers = []
            
            for header in headers_to_check:
                if header in headers:
                    present_headers.append(header)
                    f.write(f"[✓] {header}: Present\n")
                else:
                    missing_headers.append(header)
                    f.write(f"[✗] {header}: Missing\n")
            
            f.write("\n" + "-" * 50 + "\n")
            f.write(f"Summary: {len(present_headers)}/{len(headers_to_check)} security headers present\n")
            
            if missing_headers:
                f.write("\nMissing Security Headers:\n")
                for header in missing_headers:
                    f.write(f"- {header}\n")
            
            # Print summary to terminal
            print(f"Security Headers: {len(present_headers)}/{len(headers_to_check)} present")
            if missing_headers:
                print("Missing headers:")
                for header in missing_headers:
                    print(f"  - {header}")
        
        elapsed_time = time.time() - start_time
        print(f"[+] Security Headers Check completed (took {format_time(elapsed_time)})")
        return True, elapsed_time
    except Exception as e:
        elapsed_time = time.time() - start_time
        print(f"[!] Error running Security Headers Check: {e} (took {format_time(elapsed_time)})")
        return False, elapsed_time

def directory_discovery(target):
    """Basic directory discovery using curl"""
    print("\n[+] Running Directory Discovery...")
    print(f"[+] Checking common directories for {target}")
    
    start_time = time.time()
    hostname = extract_hostname(target)
    output_file = f"scan_results/directory_discovery_{hostname.replace('.', '_')}.txt"
    
    # Common directories to check
    directories = [
        "admin", "login", "wp-admin", "wp-login", "dashboard", "panel",
        "config", "setup", "install", "test", "backup", "uploads",
        "images", "css", "js", "api", "docs", "documentation"
    ]
    
    try:
        with open(output_file, 'w') as f:
            f.write("Directory Discovery Results\n")
            f.write("=" * 50 + "\n\n")
            
            found = 0
            
            for directory in directories:
                url = f"{target.rstrip('/')}/{directory}/"
                
                try:
                    # Check if directory exists with -k to ignore SSL issues
                    result = subprocess.run(
                        f"curl -k -s -o /dev/null -w '%{{http_code}}' '{url}'",
                        shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True
                    )
                    
                    status_code = result.stdout.strip()
                    
                    if status_code != '404':
                        f.write(f"Found: {url} (Status: {status_code})\n")
                        print(f"[+] Found: {url} (Status: {status_code})")
                        found += 1
                except:
                    pass
            
            f.write("\n" + "=" * 50 + "\n")
            f.write(f"Summary: {found} directories found\n")
            
            if found == 0:
                f.write("No common directories found (403 Forbidden or 404 Not Found)\n")
                print("[-] No common directories found (403 Forbidden or 404 Not Found)")
        
        elapsed_time = time.time() - start_time
        print(f"[+] Directory Discovery completed (took {format_time(elapsed_time)})")
        return True, elapsed_time
    except Exception as e:
        elapsed_time = time.time() - start_time
        print(f"[!] Error running Directory Discovery: {e} (took {format_time(elapsed_time)})")
        return False, elapsed_time

def server_info(target):
    """Gather server and technology information"""
    print("\n[+] Running Server Information Check...")
    print(f"[+] Gathering server information for {target}")
    
    start_time = time.time()
    hostname = extract_hostname(target)
    output_file = f"scan_results/server_info_{hostname.replace('.', '_')}.txt"
    
    try:
        with open(output_file, 'w') as f:
            f.write("Server Information\n")
            f.write("=" * 50 + "\n\n")
            
            # Get server headers with -k to ignore SSL issues
            result = subprocess.run(
                f"curl -k -s -I {target}",
                shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True
            )
            
            headers = result.stdout
            f.write("Response Headers:\n")
            f.write("-" * 50 + "\n")
            f.write(headers)
            f.write("\n" + "=" * 50 + "\n\n")
            
            # Extract key information
            server_info = {}
            for line in headers.split('\n'):
                if ':' in line:
                    key, value = line.split(':', 1)
                    key = key.strip()
                    value = value.strip()
                    if key.lower() in ['server', 'x-powered-by', 'content-type']:
                        server_info[key] = value
            
            f.write("Key Server Information:\n")
            f.write("-" * 50 + "\n")
            for key, value in server_info.items():
                f.write(f"{key}: {value}\n")
                print(f"{key}: {value}")
            
            # Check for common technologies
            f.write("\n" + "=" * 50 + "\n")
            f.write("Technology Detection:\n")
            f.write("-" * 50 + "\n")
            
            technologies = []
            
            # Check for common server signatures
            if 'server' in server_info:
                server = server_info['server'].lower()
                if 'apache' in server:
                    technologies.append("Apache Web Server")
                if 'nginx' in server:
                    technologies.append("Nginx Web Server")
                if 'iis' in server:
                    technologies.append("Microsoft IIS")
            
            # Check for PHP
            if 'x-powered-by' in server_info and 'php' in server_info['x-powered-by'].lower():
                technologies.append("PHP")
            
            # Check for common frameworks with -k to ignore SSL issues
            result = subprocess.run(
                f"curl -k -s {target} | grep -i 'wordpress\\|joomla\\|drupal\\|django\\|flask\\|rails'",
                shell=True, check=False, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True
            )
            
            if result.stdout:
                if 'wordpress' in result.stdout.lower():
                    technologies.append("WordPress")
                if 'joomla' in result.stdout.lower():
                    technologies.append("Joomla")
                if 'drupal' in result.stdout.lower():
                    technologies.append("Drupal")
                if 'django' in result.stdout.lower():
                    technologies.append("Django")
                if 'flask' in result.stdout.lower():
                    technologies.append("Flask")
                if 'rails' in result.stdout.lower():
                    technologies.append("Ruby on Rails")
            
            if technologies:
                for tech in technologies:
                    f.write(f"[+] Detected: {tech}\n")
                    print(f"[+] Detected: {tech}")
            else:
                f.write("[-] No specific technologies detected\n")
                print("[-] No specific technologies detected")
        
        elapsed_time = time.time() - start_time
        print(f"[+] Server Information Check completed (took {format_time(elapsed_time)})")
        return True, elapsed_time
    except Exception as e:
        elapsed_time = time.time() - start_time
        print(f"[!] Error running Server Information Check: {e} (took {format_time(elapsed_time)})")
        return False, elapsed_time

def main():
    """Main function to run the automated scanner"""
    # Set up argument parser
    parser = argparse.ArgumentParser(description='Automated Website Vulnerability Assessment Scanner')
    parser.add_argument('target', help='Target website to scan (e.g., example.com or http://example.com)')
    args = parser.parse_args()
    
    display_intro()
    
    # Check if all required tools are installed
    if not check_all_tools():
        sys.exit(1)
    
    # Get target from command line
    target = args.target
    
    # Ensure the target is properly formatted
    if not target.startswith("http://") and not target.startswith("https://"):
        target = "http://" + target
    
    print(f"\n[+] Target specified: {target}")
    
    # Get authorization confirmation
    if not get_authorization():
        sys.exit(0)
    
    print("\n[+] Starting automated vulnerability assessment scan...")
    print("[+] Results will be saved in the scan_results directory")
    
    # Create results directory
    os.makedirs("scan_results", exist_ok=True)
    
    # Extract hostname for various operations
    hostname = extract_hostname(target)
    
    # Track success and timing of each tool
    results = {}
    
    start_time = time.time()
    
    # Phase 1: IP Discovery
    print("\n" + "="*50)
    print("PHASE 1: IP DISCOVERY")
    print("="*50)
    cmd = f"dig +short {hostname}"
    output_file = f"scan_results/ip_discovery_{hostname.replace('.', '_')}.txt"
    
    try:
        with open(output_file, 'w') as f:
            f.write("IP Discovery Results\n")
            f.write("=" * 50 + "\n\n")
        
        with open(output_file, 'a') as f:
            result = subprocess.run(
                cmd,
                shell=True, check=True, stdout=f, stderr=subprocess.PIPE, text=True
            )
        
        # Get IP address from output
        with open(output_file, 'r') as f:
            content = f.read().strip()
            if content:
                ip_address = content.split('\n')[-1].strip()
                print(f"[+] Found IP address: {ip_address}")
                results["ip_discovery"] = {"success": True, "time": 0}
            else:
                print("[!] Could not resolve IP address")
                results["ip_discovery"] = {"success": False, "time": 0}
                ip_address = None
    except Exception as e:
        print(f"[!] Error running IP Discovery: {e}")
        results["ip_discovery"] = {"success": False, "time": 0}
        ip_address = None
    
    # Phase 2: Nmap
    print("\n" + "="*50)
    print("PHASE 2: NETWORK SCANNING WITH NMAP")
    print("="*50)
    if ip_address:
        success, elapsed = run_nmap(target, ip_address)
        results["nmap"] = {"success": success, "time": elapsed}
    else:
        print("[!] No IP address available, skipping Nmap scan")
        results["nmap"] = {"success": False, "time": 0}
    
    # Phase 3: Security Headers Check
    print("\n" + "="*50)
    print("PHASE 3: SECURITY HEADERS CHECK")
    print("="*50)
    success, elapsed = check_security_headers(target)
    results["security_headers"] = {"success": success, "time": elapsed}
    
    # Phase 4: Directory Discovery
    print("\n" + "="*50)
    print("PHASE 4: DIRECTORY DISCOVERY")
    print("="*50)
    success, elapsed = directory_discovery(target)
    results["directory_discovery"] = {"success": success, "time": elapsed}
    
    # Phase 5: Server Information
    print("\n" + "="*50)
    print("PHASE 5: SERVER INFORMATION")
    print("="*50)
    success, elapsed = server_info(target)
    results["server_info"] = {"success": success, "time": elapsed}
    
    # Display summary
    end_time = time.time()
    total_time = end_time - start_time
    
    print("\n" + "="*50)
    print("SCAN SUMMARY")
    print("="*50)
    print(f"Target: {target}")
    print(f"IP Address: {ip_address if ip_address else 'Not found'}")
    print(f"Total scan time: {format_time(total_time)}")
    print("\nTool Status and Timing:")
    for tool, data in results.items():
        status = "SUCCESS" if data["success"] else "FAILED"
        print(f"  {tool}: {status} (took {format_time(data['time'])})")
    
    print("\nResults Location:")
    print(f"  All results saved in: {os.path.abspath('scan_results')}")
    
    print("\n[+] Automated vulnerability assessment scan completed!")
    print("[+] Please review the results in the scan_results directory")

if __name__ == "__main__":
    main()